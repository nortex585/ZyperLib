--[[ 
    ZYPER LIBRARY (DÜZELTİLMİŞ & ENTEGRE EDİLMİŞ VERSİYON)
]]

local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local CoreGui = game:GetService("CoreGui")

local ZyperLib = {
    Elements = {},
    ThemeObjects = {},
    Connections = {},
    Flags = {},
    Themes = {
        Default = {
            Main = Color3.fromRGB(25, 25, 25),
            Second = Color3.fromRGB(32, 32, 32),
            Stroke = Color3.fromRGB(60, 60, 60),
            Divider = Color3.fromRGB(60, 60, 60),
            Text = Color3.fromRGB(240, 240, 240),
            TextDark = Color3.fromRGB(150, 150, 150)
        }
    },
    SelectedTheme = "Default",
    Folder = nil,
    SaveCfg = false
}

local Zyper = Instance.new("ScreenGui")
Zyper.Name = "Zyper"
if syn then
    syn.protect_gui(Zyper)
    Zyper.Parent = CoreGui
elseif gethui then
    Zyper.Parent = gethui()
else
    Zyper.Parent = CoreGui
end

if gethui then
    for _, gui in ipairs(gethui():GetChildren()) do
        if gui.Name == Zyper.Name and gui ~= Zyper then gui:Destroy() end
    end
else
    for _, gui in ipairs(CoreGui:GetChildren()) do
        if gui.Name == Zyper.Name and gui ~= Zyper then gui:Destroy() end
    end
end

function ZyperLib:IsRunning()
    return Zyper.Parent ~= nil
end

local function AddConnection(Signal, Func)
    if not ZyperLib:IsRunning() then return end
    local conn = Signal:Connect(Func)
    table.insert(ZyperLib.Connections, conn)
    return conn
end

local function MakeDraggable(topbar, main)
    local dragging, dragInput, dragStart, startPos
    AddConnection(topbar.InputBegan, function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = main.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    AddConnection(topbar.InputChanged, function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    AddConnection(UserInputService.InputChanged, function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
end

local function Create(Name, Props, Children)
    local obj = Instance.new(Name)
    for i, v in next, Props or {} do obj[i] = v end
    for i, v in next, Children or {} do v.Parent = obj end
    return obj
end

local function AddThemeObject(obj, type)
    if not ZyperLib.ThemeObjects[type] then ZyperLib.ThemeObjects[type] = {} end
    table.insert(ZyperLib.ThemeObjects[type], obj)
    local prop = obj:IsA("Frame") or obj:IsA("TextButton") and "BackgroundColor3" or
                obj:IsA("ScrollingFrame") and "ScrollBarImageColor3" or
                obj:IsA("UIStroke") and "Color" or
                obj:IsA("TextLabel") or obj:IsA("TextBox") and "TextColor3" or
                obj:IsA("ImageLabel") or obj:IsA("ImageButton") and "ImageColor3"
    if prop then obj[prop] = ZyperLib.Themes[ZyperLib.SelectedTheme][type] end
    return obj
end

-- Basit bir MakeWindow fonksiyonu (Karmaşıklığı azalttım ve hatalı resmi kaldırdım)
function ZyperLib:MakeWindow(cfg)
    cfg = cfg or {}
    local MainWindow = AddThemeObject(Create("Frame", {
        Name = "MainWindow",
        Parent = Zyper,
        BackgroundColor3 = Color3.fromRGB(25,25,25),
        Size = UDim2.new(0, 500, 0, 350), -- Boyutu biraz küçülttüm
        Position = UDim2.new(0.5, -250, 0.5, -175),
        ClipsDescendants = true
    }, {
        Create("UICorner", {CornerRadius = UDim.new(0,10)}),
        Create("UIStroke", {Color = Color3.fromRGB(60,60,60), Thickness = 1}),
        
        -- Hatalı ImageLabel'ı kaldırdım, düz renk arka plan bıraktım
        Create("TextLabel", {
            Name = "Title",
            Text = cfg.Name or "Zyper Lib",
            Font = Enum.Font.GothamBold,
            TextSize = 18,
            TextColor3 = Color3.fromRGB(255,255,255),
            Size = UDim2.new(1, -20, 0, 40),
            Position = UDim2.new(0, 10, 0, 0),
            BackgroundTransparency = 1,
            XAlignment = Enum.TextXAlignment.Left
        })
    }), "Main")

    MakeDraggable(MainWindow, MainWindow)
    
    local Container = Create("ScrollingFrame", {
        Name = "Container",
        Parent = MainWindow,
        Size = UDim2.new(1, -20, 1, -50),
        Position = UDim2.new(0, 10, 0, 45),
        BackgroundTransparency = 1,
        ScrollBarThickness = 2,
        CanvasSize = UDim2.new(0,0,0,0),
        AutomaticCanvasSize = Enum.AutomaticSize.Y
    })
    
    local UIList = Create("UIListLayout", {
        Parent = Container,
        Padding = UDim.new(0, 5),
        SortOrder = Enum.SortOrder.LayoutOrder
    })

    local WindowFunctions = {}

    function WindowFunctions:MakeTab(tabCfg)
        -- Basitlik için Tab mantığını Section gibi kullanıyoruz (Black screen fix için)
        -- Gerçek bir tab sistemi için butonlar eklenmeli, şimdilik direkt container'a ekliyoruz.
        local TabFunctions = {}
        
        function TabFunctions:AddButton(btnCfg)
            local ButtonFrame = Create("TextButton", {
                Name = btnCfg.Name,
                Parent = Container,
                Size = UDim2.new(1, 0, 0, 35),
                BackgroundColor3 = Color3.fromRGB(35, 35, 35),
                Text = "",
                AutoButtonColor = false
            }, {
                Create("UICorner", {CornerRadius = UDim.new(0, 6)}),
                Create("TextLabel", {
                    Text = btnCfg.Name,
                    Size = UDim2.new(1, -10, 1, 0),
                    Position = UDim2.new(0, 10, 0, 0),
                    BackgroundTransparency = 1,
                    TextColor3 = Color3.fromRGB(240, 240, 240),
                    Font = Enum.Font.Gotham,
                    TextSize = 14,
                    XAlignment = Enum.TextXAlignment.Left
                })
            })
            
            ButtonFrame.MouseButton1Click:Connect(function()
                if btnCfg.Callback then btnCfg.Callback() end
            end)
        end
        
        function TabFunctions:AddToggle(tglCfg)
            local toggled = tglCfg.Default or false
            local ToggleBtn = Create("TextButton", {
                Parent = Container,
                Size = UDim2.new(1, 0, 0, 35),
                BackgroundColor3 = Color3.fromRGB(35, 35, 35),
                Text = "",
                AutoButtonColor = false
            }, {
                Create("UICorner", {CornerRadius = UDim.new(0, 6)}),
                Create("TextLabel", {
                    Text = tglCfg.Name,
                    Size = UDim2.new(1, -40, 1, 0),
                    Position = UDim2.new(0, 10, 0, 0),
                    BackgroundTransparency = 1,
                    TextColor3 = Color3.fromRGB(240, 240, 240),
                    Font = Enum.Font.Gotham,
                    TextSize = 14,
                    XAlignment = Enum.TextXAlignment.Left
                }),
                Create("Frame", {
                    Name = "Status",
                    Size = UDim2.new(0, 20, 0, 20),
                    Position = UDim2.new(1, -30, 0.5, -10),
                    BackgroundColor3 = toggled and Color3.fromRGB(0, 255, 100) or Color3.fromRGB(60, 60, 60)
                }, {Create("UICorner", {CornerRadius = UDim.new(0,4)})})
            })
            
            ToggleBtn.MouseButton1Click:Connect(function()
                toggled = not toggled
                ToggleBtn.Status.BackgroundColor3 = toggled and Color3.fromRGB(0, 255, 100) or Color3.fromRGB(60, 60, 60)
                if tglCfg.Callback then tglCfg.Callback(toggled) end
            end)
        end

        function TabFunctions:AddSlider(sldCfg)
            -- Slider örneği
            local SliderFrame = Create("Frame", {
                Parent = Container,
                Size = UDim2.new(1, 0, 0, 50),
                BackgroundColor3 = Color3.fromRGB(35, 35, 35)
            }, {
                Create("UICorner", {CornerRadius = UDim.new(0, 6)}),
                Create("TextLabel", {
                    Text = sldCfg.Name,
                    Position = UDim2.new(0,10,0,5),
                    Size = UDim2.new(1,-20,0,20),
                    BackgroundTransparency = 1,
                    TextColor3 = Color3.fromRGB(240,240,240),
                    Font = Enum.Font.Gotham,
                    TextSize = 14,
                    XAlignment = Enum.TextXAlignment.Left
                })
            })
            -- Slider logic'i buraya eklenebilir, basit tuttum.
        end

        return TabFunctions
    end

    function WindowFunctions:Init()
        -- Config yükleme simülasyonu
    end

    return WindowFunctions
end

--[[ 
    ÖRNEK KULLANIM (SCRIPT KISMI) 
]]

local Window = ZyperLib:MakeWindow({
    Name = "Zyper Hub | Fix Version",
    ConfigFolder = "ZyperConfig"
})

local Tab = Window:MakeTab({Name = "Main"})

Tab:AddToggle({
    Name = "Sonsuz Zıplama (Infinite Jump)",
    Default = false,
    Callback = function(state)
        _G.InfJump = state
    end
})

game:GetService("UserInputService").JumpRequest:Connect(function()
    if _G.InfJump then
        game:GetService("Players").LocalPlayer.Character:FindFirstChildOfClass('Humanoid'):ChangeState("Jumping")
    end
end)

Tab:AddButton({
    Name = "Hızı 100 Yap",
    Callback = function()
        if LocalPlayer.Character then
            LocalPlayer.Character.Humanoid.WalkSpeed = 100
        end
    end
})

Tab:AddButton({
    Name = "Hızı Sıfırla (16)",
    Callback = function()
        if LocalPlayer.Character then
            LocalPlayer.Character.Humanoid.WalkSpeed = 16
        end
    end
})

Tab:AddButton({
    Name = "GUI Kapat (Destroy)",
    Callback = function()
        Zyper:Destroy()
    end
})
